services:
  psql: # Function
    instances:
      af: # network_zone
        replicas: 2 # Server Count
        project_network: !template "af.wallet.{environment}" # Name of the project network
      aw:
        replicas: 1
        project_network: !template "aw.wallet.{environment}"
    firewall:
      intern: # Used for internal SG
        - tcp5432
        - tcp22
      export: # Used to create server SG
        - ports:
            - tcp5432
          name: !template "{subproject}-{environment}-psql-server.{project}.sg"
      import: # Used to create client SG from remote SG
        - ports:
            - tcp8140
          service: puppet
          references:
            - puppetca-server.admin.sg
            - puppet.admin.sg
            - puppet-admin-server.admin.sg
    vm: # Additional args for created VMs
      os: bookworm
      puppet_classes:
        - !template "{project}::psql"
        - !template "{project}::repmgr"
      backup_disabled: true
      repositories:
        - !template "int:{project}_bookworm:stable"
        - "int:innogames:stable"
      puppet_master: payment-puppet.admin.innogames.fail
      puppet_ca: puppetca.admin.innogames.fail


  web:
    instances:
      af:
        replicas: 4
        project_network: !template "af.wallet.{environment}"
      aw:
        replicas: 4
        project_network: !template "aw.wallet.{environment}"
    firewall:
      import:
        - ports:
            - tcp5432
          service: psql
          references:
            - !template "{subproject}-{environment}-psql-server.{project}.sg"
    vm:
      os: bookworm
      puppet_classes:
        - !template "{project}::web"
      backup_disabled: true
      repositories:
        - !template "int:{project}_bookworm:stable"
        - "int:innogames:stable"
      puppet_master: payment-puppet.admin.innogames.fail
      puppet_ca: puppetca.admin.innogames.fail
